name: üìù Atualizar README Automaticamente

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'CHANGELOG.md'
      - 'src/**'
      - 'projects/**'
      - 'web/**'
      - 'viewer3d/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  update-readme:
    name: Atualizar README.md com √∫ltimas mudan√ßas
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Obter informa√ß√µes do √∫ltimo commit
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_DATE=$(git log -1 --pretty=%cd --date=short)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
      
      - name: Extrair √∫ltimas mudan√ßas do CHANGELOG
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extrair as √∫ltimas 3 vers√µes do changelog
            LATEST_CHANGES=$(awk '/^## \[/{count++; if(count<=3) print; if(count>3) exit} /^## \[/,/^## \[/{if(count<=3) print}' CHANGELOG.md | head -n 50)
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "$LATEST_CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changes=### Sem changelog dispon√≠vel ainda." >> $GITHUB_OUTPUT
          fi
      
      - name: Obter √∫ltimas features implementadas
        id: features
        run: |
          # Buscar √∫ltimos commits do tipo feat
          FEATURES=$(git log --oneline --grep="^feat" -10 --pretty=format:"- %s (%h)" | head -n 10)
          if [ -z "$FEATURES" ]; then
            FEATURES="- Nenhuma feature nova registrada"
          fi
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$FEATURES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Atualizar README.md
        run: |
          # Criar se√ß√£o de changelog no README se n√£o existir
          if ! grep -q "## üìù Changelog" README.md; then
            # Adicionar antes da se√ß√£o de Contato ou no final
            if grep -q "## üìû Contato" README.md; then
              sed -i '/## üìû Contato/i\\n## üìù Changelog\n\n### √öltimas Mudan√ßas\n\n${{ steps.changelog.outputs.changes }}\n\n### √öltimas Features\n\n${{ steps.features.outputs.list }}\n\n---\n\nüìã **√öltima atualiza√ß√£o**: ${{ steps.commit_info.outputs.date }} por ${{ steps.commit_info.outputs.author }}\n\nüí° Para ver o changelog completo, consulte [CHANGELOG.md](CHANGELOG.md)\n\n' README.md
            else
              echo "" >> README.md
              echo "## üìù Changelog" >> README.md
              echo "" >> README.md
              echo "### √öltimas Mudan√ßas" >> README.md
              echo "" >> README.md
              echo '${{ steps.changelog.outputs.changes }}' >> README.md
              echo "" >> README.md
              echo "### √öltimas Features" >> README.md
              echo "" >> README.md
              echo '${{ steps.features.outputs.list }}' >> README.md
              echo "" >> README.md
              echo "---" >> README.md
              echo "" >> README.md
              echo "üìã **√öltima atualiza√ß√£o**: ${{ steps.commit_info.outputs.date }} por ${{ steps.commit_info.outputs.author }}" >> README.md
              echo "" >> README.md
              echo "üí° Para ver o changelog completo, consulte [CHANGELOG.md](CHANGELOG.md)" >> README.md
            fi
          else
            # Atualizar se√ß√£o existente
            # Criar arquivo tempor√°rio com novo conte√∫do
            cat > /tmp/changelog_section.md << 'EOF'
## üìù Changelog

### √öltimas Mudan√ßas

${{ steps.changelog.outputs.changes }}

### √öltimas Features

${{ steps.features.outputs.list }}

---

üìã **√öltima atualiza√ß√£o**: ${{ steps.commit_info.outputs.date }} por ${{ steps.commit_info.outputs.author }}

üí° Para ver o changelog completo, consulte [CHANGELOG.md](CHANGELOG.md)

EOF
            # Substituir se√ß√£o existente
            python3 << 'PYTHON'
import re

with open('README.md', 'r', encoding='utf-8') as f:
    content = f.read()

# Remover se√ß√£o antiga de changelog
pattern = r'## üìù Changelog.*?(?=\n## |$)'
content = re.sub(pattern, '', content, flags=re.DOTALL)

# Ler novo conte√∫do
with open('/tmp/changelog_section.md', 'r', encoding='utf-8') as f:
    new_section = f.read()

# Substituir vari√°veis
import os
new_section = new_section.replace('${{ steps.changelog.outputs.changes }}', os.environ.get('CHANGELOG_CONTENT', ''))
new_section = new_section.replace('${{ steps.features.outputs.list }}', os.environ.get('FEATURES_LIST', ''))
new_section = new_section.replace('${{ steps.commit_info.outputs.date }}', os.environ.get('COMMIT_DATE', ''))
new_section = new_section.replace('${{ steps.commit_info.outputs.author }}', os.environ.get('COMMIT_AUTHOR', ''))

# Inserir antes de Contato ou no final
if '## üìû Contato' in content:
    content = content.replace('## üìû Contato', new_section + '\n\n## üìû Contato')
else:
    content += '\n\n' + new_section

with open('README.md', 'w', encoding='utf-8') as f:
    f.write(content)
PYTHON
          fi
      
      - name: Commit mudan√ßas no README
        env:
          CHANGELOG_CONTENT: ${{ steps.changelog.outputs.changes }}
          FEATURES_LIST: ${{ steps.features.outputs.list }}
          COMMIT_DATE: ${{ steps.commit_info.outputs.date }}
          COMMIT_AUTHOR: ${{ steps.commit_info.outputs.author }}
        run: |
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "docs(readme): atualizar changelog automaticamente [skip release]"
            git push
          else
            echo "Nenhuma mudan√ßa no README para fazer commit"
          fi
